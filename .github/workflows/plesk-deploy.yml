name: Deploy to Plesk

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  publish-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Publish
      run: dotnet publish -c Release -o ./publish

    # STEP 1: Create styled app_offline.htm to show maintenance message
    - name: Create styled app_offline.htm
      run: |
        cat <<'EOF' > app_offline.htm
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Updating...</title>
            <style>
                body {
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #FFF5E4 0%, #FFE3E1 100%);
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    color: #495057;
                    text-align: center;
                }
                .message-container {
                    margin-top: 40px;
                }
                h2 {
                    font-size: 1.2rem;
                    margin: 15px 0;
                    font-weight: 400;
                    opacity: 0.9;
                }
                
                /* Pencil Animation Styles */
                .pencil {
                  display: block;
                  width: 10em;
                  height: 10em;
                  margin: 0 auto;
                  color: #FF9494;
                }

                .pencil__body1,
                .pencil__body2,
                .pencil__body3,
                .pencil__eraser,
                .pencil__eraser-skew,
                .pencil__point,
                .pencil__rotate,
                .pencil__stroke {
                  animation-duration: 3s;
                  animation-timing-function: linear;
                  animation-iteration-count: infinite;
                }

                .pencil__body1,
                .pencil__body2,
                .pencil__body3 {
                  transform: rotate(-90deg);
                }

                .pencil__body1 {
                  animation-name: pencilBody1;
                }

                .pencil__body2 {
                  animation-name: pencilBody2;
                }

                .pencil__body3 {
                  animation-name: pencilBody3;
                }

                .pencil__eraser {
                  animation-name: pencilEraser;
                  transform: rotate(-90deg) translate(49px,0);
                }

                .pencil__eraser-skew {
                  animation-name: pencilEraserSkew;
                  animation-timing-function: ease-in-out;
                }

                .pencil__point {
                  animation-name: pencilPoint;
                  transform: rotate(-90deg) translate(49px,-30px);
                }

                .pencil__rotate {
                  animation-name: pencilRotate;
                }

                .pencil__stroke {
                  animation-name: pencilStroke;
                  transform: translate(100px,100px) rotate(-113deg);
                }

                @keyframes pencilBody1 {
                  from, to {
                    stroke-dashoffset: 351.86;
                    transform: rotate(-90deg);
                  }
                  50% {
                    stroke-dashoffset: 150.8;
                    transform: rotate(-225deg);
                  }
                }

                @keyframes pencilBody2 {
                  from, to {
                    stroke-dashoffset: 406.84;
                    transform: rotate(-90deg);
                  }
                  50% {
                    stroke-dashoffset: 174.36;
                    transform: rotate(-225deg);
                  }
                }

                @keyframes pencilBody3 {
                  from, to {
                    stroke-dashoffset: 296.88;
                    transform: rotate(-90deg);
                  }
                  50% {
                    stroke-dashoffset: 127.23;
                    transform: rotate(-225deg);
                  }
                }

                @keyframes pencilEraser {
                  from, to {
                    transform: rotate(-45deg) translate(49px,0);
                  }
                  50% {
                    transform: rotate(0deg) translate(49px,0);
                  }
                }

                @keyframes pencilEraserSkew {
                  from, 32.5%, 67.5%, to {
                    transform: skewX(0);
                  }
                  35%, 65% {
                    transform: skewX(-4deg);
                  }
                  37.5%, 62.5% {
                    transform: skewX(8deg);
                  }
                  40%, 45%, 50%, 55%, 60% {
                    transform: skewX(-15deg);
                  }
                  42.5%, 47.5%, 52.5%, 57.5% {
                    transform: skewX(15deg);
                  }
                }

                @keyframes pencilPoint {
                  from, to {
                    transform: rotate(-90deg) translate(49px,-30px);
                  }
                  50% {
                    transform: rotate(-225deg) translate(49px,-30px);
                  }
                }

                @keyframes pencilRotate {
                  from {
                    transform: translate(100px,100px) rotate(0);
                  }
                  to {
                    transform: translate(100px,100px) rotate(720deg);
                  }
                }

                @keyframes pencilStroke {
                  from {
                    stroke-dashoffset: 439.82;
                    transform: translate(100px,100px) rotate(-113deg);
                  }
                  50% {
                    stroke-dashoffset: 164.93;
                    transform: translate(100px,100px) rotate(-113deg);
                  }
                  75%, to {
                    stroke-dashoffset: 439.82;
                    transform: translate(100px,100px) rotate(112deg);
                  }
                }
            </style>
        </head>
        <body>
            <svg xmlns="http://www.w3.org/2000/svg" height="200px" width="200px" viewBox="0 0 200 200" class="pencil">
                <defs>
                    <clipPath id="pencil-eraser">
                        <rect height="30" width="30" ry="5" rx="5"></rect>
                    </clipPath>
                </defs>
                <circle transform="rotate(-113,100,100)" stroke-linecap="round" stroke-dashoffset="439.82" stroke-dasharray="439.82 439.82" stroke-width="2" stroke="currentColor" fill="none" r="70" class="pencil__stroke"></circle>
                <g transform="translate(100,100)" class="pencil__rotate">
                    <g fill="none">
                        <circle transform="rotate(-90)" stroke-dashoffset="402" stroke-dasharray="402.12 402.12" stroke-width="30" stroke="hsl(223,90%,50%)" r="64" class="pencil__body1"></circle>
                        <circle transform="rotate(-90)" stroke-dashoffset="465" stroke-dasharray="464.96 464.96" stroke-width="10" stroke="hsl(223,90%,60%)" r="74" class="pencil__body2"></circle>
                        <circle transform="rotate(-90)" stroke-dashoffset="339" stroke-dasharray="339.29 339.29" stroke-width="10" stroke="hsl(223,90%,40%)" r="54" class="pencil__body3"></circle>
                    </g>
                    <g transform="rotate(-90) translate(49,0)" class="pencil__eraser">
                        <g class="pencil__eraser-skew">
                            <rect height="30" width="30" ry="5" rx="5" fill="hsl(223,90%,70%)"></rect>
                            <rect clip-path="url(#pencil-eraser)" height="30" width="5" fill="hsl(223,90%,60%)"></rect>
                            <rect height="20" width="30" fill="hsl(223,10%,90%)"></rect>
                            <rect height="20" width="15" fill="hsl(223,10%,70%)"></rect>
                            <rect height="20" width="5" fill="hsl(223,10%,80%)"></rect>
                            <rect height="2" width="30" y="6" fill="hsla(223,10%,10%,0.2)"></rect>
                            <rect height="2" width="30" y="13" fill="hsla(223,10%,10%,0.2)"></rect>
                        </g>
                    </g>
                    <g transform="rotate(-90) translate(49,-30)" class="pencil__point">
                        <polygon points="15 0,30 30,0 30" fill="hsl(33,90%,70%)"></polygon>
                        <polygon points="15 0,6 30,0 30" fill="hsl(33,90%,50%)"></polygon>
                        <polygon points="15 0,20 10,10 10" fill="hsl(223,10%,10%)"></polygon>
                    </g>
                </g>
            </svg>

            <div class="message-container">
                <h2>ðŸ”„ The system is updating...</h2>
                <h2>Please wait approximately 3 minutes.</h2>
                <h2></h2>
                <h2>ðŸ”„ Das System wird aktualisiert...</h2>
                <h2>Bitte warten Sie etwa 3 Minuten.</h2>
                <h2></h2>
                <h2>ðŸ”„ Sistem gÃ¼ncelleniyor...</h2>
                <h2>LÃ¼tfen yaklaÅŸÄ±k 3 dakika bekleyin.</h2>
            </div>
        </body>
        </html>
        EOF

    # STEP 2: Upload app_offline.htm to put site in maintenance mode
    - name: FTP Upload app_offline (Start Maintenance)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: ./
        exclude: |
          **/*
          !app_offline.htm
        protocol: ftp

    # STEP 3: Wait to ensure all file locks are released
    - name: Wait 3 minutes for locks to release
      run: sleep 180

    # STEP 4: Deploy all published files
    - name: FTP Deploy (Full Application)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./publish/
        server-dir: ./
        protocol: ftp

    # STEP 5: Remove app_offline.htm to bring site back online
    - name: Remove app_offline.htm (End Maintenance)
      run: |
        lftp -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} -e "cd /; rm app_offline.htm; quit" ${{ secrets.FTP_SERVER }}

    # STEP 6: Verify deployment
    - name: Verify Deployment
      run: echo "âœ… Deployment to Plesk completed successfully!"
