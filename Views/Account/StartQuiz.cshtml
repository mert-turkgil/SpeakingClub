@model SpeakingClub.Entity.Quiz
@inject LanguageService _localization
@{    
    var isGerman = System.Globalization.CultureInfo.CurrentCulture.TwoLetterISOLanguageName == "de";
    var quizzesPath = isGerman ? "/pruefungen" : "/sinavlar";
    var fullscreenExitUrl = quizzesPath + "?warning=FullscreenExit";
    var leaveScreenUrl = quizzesPath + "?warning=LeaveScreen";
    var inactivityUrl = quizzesPath + "?warning=Inactivity";
    var submitQuizUrl = Url.Action("SubmitQuiz", "Account");
    }
<!-- Fullscreen Quiz Container -->
<div id="quizContainer" class="fullscreen-container">
    <div class="quiz-header">
        <h2>@Model.Title</h2>
        <div id="overallTimer">
            <i class="bi bi-clock-fill"></i> @_localization.GetKey("TotalTimeLabel") <span id="totalTime">00:00</span>
        </div>
    </div>

    <form id="quizForm" method="post" asp-controller="Account" asp-action="SubmitQuiz">
        <input type="hidden" name="QuizId" value="@Model.Id.ToString()" />
        <input type="hidden" name="ElapsedTime" id="elapsedTime" value="0" />

        <div id="questionsContainer">
            @for (int i = 0; i < Model.Questions.Count; i++)
            {
                var question = Model.Questions.ElementAt(i);
                var shuffledAnswers = question.Answers.OrderBy(_ => Guid.NewGuid()).ToList(); // Shuffle answers

                <div class="question-panel" data-index="@i" style="display:@(i == 0 ? "block" : "none")">
                    <div class="question-card">
                        <div class="question-header">
                            <span class="question-number">Soru @(i + 1) / @Model.Questions.Count</span>
                            <h3 class="question-title">@question.QuestionText</h3>
                        </div>

                        <div class="question-media-content">
                            @* Display media if provided *@
                            @if (!string.IsNullOrEmpty(question.ImageUrl))
                            {
                                <div class="media-item">
                                    <img src="@Url.Content(question.ImageUrl)" class="question-image" alt="Question Image" />
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(question.VideoUrl))
                            {
                                <div class="media-item">
                                    <div class="video-wrapper">
                                        <iframe width="100%" height="315" src="@question.VideoUrl" frameborder="0" allowfullscreen></iframe>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(question.AudioUrl))
                            {
                                <div class="media-item audio-item">
                                    <div class="audio-label"><i class="bi bi-music-note-beamed"></i> Dinle:</div>
                                    <audio controls class="question-audio">
                                        <source src="@Url.Content("~/mp3/" + question.AudioUrl)" type="audio/mpeg" />
                                        @_localization.GetKey("AudioNotSupported")
                                    </audio>
                                </div>
                            }
                        </div>

                        <div class="question-answers">
                            @foreach (var answer in shuffledAnswers)
                            {
                                <label class="answer-option">
                                    <input class="answer-check" type="radio" 
                                        name="responses[@question.Id]" 
                                        value="@answer.Id" />
                                    <span class="answer-text">@answer.AnswerText</span>
                                </label>
                            }
                        </div>
                        
                        <input type="hidden" name="QuestionTimes[@question.Id]" class="question-time" value="0" />
                    </div>

                    <div class="question-controls">
                        <button type="button" class="btn-nav btn-nav-prev prevBtn" @(i == 0 ? "disabled" : "")>
                            <i class="bi bi-chevron-left"></i> @_localization.GetKey("PreviousButton")
                        </button>
                        @if (i < Model.Questions.Count - 1)
                        {
                            <button type="button" class="btn-nav btn-nav-next nextBtn">
                                @_localization.GetKey("NextButton") <i class="bi bi-chevron-right"></i>
                            </button>
                        }
                        else
                        {
                            <button form="quizForm" type="submit" class="btn-submit">
                                <i class="bi bi-check-circle-fill"></i> @_localization.GetKey("SubmitExamButton")
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    </form>
</div>

<!-- Start Exam Modal -->
<div id="startExamModal" class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <h5>@_localization.GetKey("StartQuizModalTitle")</h5>
            <p>@_localization.GetKey("StartQuizModalMessage")</p>
            <button class="btn btn-primary" id="startQuizBtn">@_localization.GetKey("StartQuizButton")</button>
        </div>
    </div>
</div>
<div id="loadingOverlay" style="
    display: none; position: fixed; z-index: 99999;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5);
    color: white; font-size: 2rem;
    justify-content: center; align-items: center; text-align: center;">
    <div>
        <div class="spinner-border text-light mb-3" role="status"></div>
        <div>Lütfen bekleyin, sınav kaydediliyor...</div>
    </div>
</div>


@section Css {
    <style>
        :root {
            --quiz-lightest: #FFF5E4;
            --quiz-light: #FFE3E1;
            --quiz-medium: #FFD1D1;
            --quiz-accent: #FF9494;
        }
        
        #loadingOverlay {
            display: none;
            position: fixed; z-index: 99999;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, rgba(255,148,148,0.95) 0%, rgba(255,209,209,0.95) 100%);
            color: white; font-size: 1.5rem;
            justify-content: center; align-items: center;
            text-align: center;
        }
        #loadingOverlay.active { display: flex; }

        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .fullscreen-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(180deg, var(--quiz-lightest) 0%, #fff 100%);
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .quiz-header {
            background: linear-gradient(135deg, var(--quiz-accent) 0%, var(--quiz-medium) 100%);
            color: white;
            padding: 25px 30px;
            box-shadow: 0 5px 20px rgba(255,148,148,0.3);
            flex-shrink: 0;
        }
        
        .quiz-header h2 {
            margin: 0 0 15px 0;
            font-weight: 800;
            font-size: 1.75rem;
        }
        
        #overallTimer {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
        }
        
        #overallTimer i {
            font-size: 1.3rem;
        }
        
        #questionsContainer {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        
        .question-panel {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .question-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            padding: 30px;
        }
        
        .question-header {
            margin-bottom: 25px;
            border-bottom: 2px solid var(--quiz-light);
            padding-bottom: 15px;
        }
        
        .question-number {
            display: inline-block;
            background: var(--quiz-light);
            color: var(--quiz-accent);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .question-title {
            color: #333;
            font-weight: 700;
            font-size: 1.35rem;
            line-height: 1.5;
            margin: 0;
        }
        
        .question-media-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .media-item {
            background: var(--quiz-lightest);
            border-radius: 15px;
            padding: 15px;
            overflow: hidden;
        }
        
        .question-image {
            width: 100%;
            border-radius: 12px;
            display: block;
            max-height: 350px;
            object-fit: cover;
        }
        
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }
        
        .audio-item {
            background: linear-gradient(135deg, var(--quiz-light) 0%, var(--quiz-lightest) 100%);
            border-left: 4px solid var(--quiz-accent);
            padding: 20px;
        }
        
        .audio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--quiz-accent);
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        
        .audio-label i {
            font-size: 1.2rem;
        }
        
        .question-audio {
            width: 100%;
            border-radius: 8px;
            padding: 8px 12px;
        }
        
        .question-answers {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 25px 0;
        }
        
        .answer-option {
            display: flex;
            align-items: center;
            background: var(--quiz-lightest);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .answer-option:hover {
            background: var(--quiz-light);
            transform: translateX(8px);
        }
        
        .answer-option input:checked + .answer-text {
            color: var(--quiz-accent);
            font-weight: 700;
        }
        
        .answer-check {
            width: 22px;
            height: 22px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--quiz-accent);
        }
        
        .answer-text {
            flex: 1;
            color: #444;
            font-size: 1.05rem;
            line-height: 1.5;
        }
        
        .question-controls {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            padding-top: 20px;
            border-top: 2px solid var(--quiz-light);
        }
        
        .btn-nav, .btn-submit {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .btn-nav-prev {
            background: #e9ecef;
            color: #666;
        }
        
        .btn-nav-prev:hover:not(:disabled) {
            background: #dee2e6;
            transform: translateX(-3px);
        }
        
        .btn-nav-prev:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-nav-next {
            background: linear-gradient(135deg, var(--quiz-accent) 0%, var(--quiz-medium) 100%);
            color: white;
            margin-left: auto;
        }
        
        .btn-nav-next:hover {
            transform: translateX(3px);
            box-shadow: 0 8px 20px rgba(255,148,148,0.4);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            margin-left: auto;
            min-width: 180px;
            justify-content: center;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(40,167,69,0.4);
        }
        
        .modal {
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: white;
            border-radius: 25px;
            border: none;
            box-shadow: 0 25px 80px rgba(0,0,0,0.2);
        }
        
        .modal-content h5 {
            color: var(--quiz-accent);
            font-weight: 800;
            font-size: 1.5rem;
        }
        
        .modal-content p {
            color: #666;
            font-size: 1.05rem;
        }
        
        .fullscreen-mode .navbar, 
        .fullscreen-mode .footer, 
        .fullscreen-mode .header {
            display: none !important;
        }
        
        /* Scrollbar styling */
        #questionsContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #questionsContainer::-webkit-scrollbar-track {
            background: var(--quiz-light);
            border-radius: 10px;
        }
        
        #questionsContainer::-webkit-scrollbar-thumb {
            background: var(--quiz-accent);
            border-radius: 10px;
        }
        
        #questionsContainer::-webkit-scrollbar-thumb:hover {
            background: #ff7b7b;
        }
        
        @@media (max-width: 768px) {
            .quiz-header {
                padding: 15px 20px;
            }
            
            .quiz-header h2 {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            
            #questionsContainer {
                padding: 20px;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .question-title {
                font-size: 1.1rem;
            }
            
            .answer-option {
                padding: 12px 15px;
            }
            
            .question-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-nav, .btn-submit {
                width: 100%;
                justify-content: center;
            }
            
            .btn-nav-next {
                margin-left: 0;
            }
            
            .btn-submit {
                margin-left: 0;
                min-width: auto;
            }
        }
    </style>
}

@section Scripts {
    <script>
    function showLoadingOverlay() {
        var overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'flex'; // veya overlay.classList.add('active');
    }
    </script>
    <script>
        let isSubmitting = false;
        function autoSubmitQuizAndRedirect(redirectUrl) {
            if (isSubmitting) return;
            isSubmitting = true;
            showLoadingOverlay();
            // Formun DOM'daki ID'si
            var form = document.getElementById('quizForm');
            if (!form) {
                window.location.href = redirectUrl;
                return;
            }

            // Formdaki verileri al
            var formData = new FormData(form);

            // ElapsedTime'ı hesapla (eğer examStartTime değişkenin varsa)
            if (typeof examStartTime !== "undefined") {
                formData.set('ElapsedTime', Math.floor((Date.now() - examStartTime) / 1000));
            }

            // Fetch ile AJAX submit
            fetch('@submitQuizUrl', {
                method: "POST",
                body: formData,
                credentials: "include"
            })
            .then(function () {
                window.location.href = redirectUrl;
            })
            .catch(function () {
                // Yine de yönlendir
                window.location.href = redirectUrl;
            });
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let examStartTime;
            let overallTimerInterval;
            let currentQuestionIndex = 0;
            let questionStartTime = Date.now();
            let warningTimeout;
            let inactivityTimeout;

            // Start Exam Button - Go Fullscreen
            document.getElementById("startQuizBtn").addEventListener("click", function () {
                let quizContainer = document.getElementById("quizContainer");
                quizContainer.style.display = "block";

                // Request fullscreen
                if (quizContainer.requestFullscreen) {
                    quizContainer.requestFullscreen();
                } else if (quizContainer.mozRequestFullScreen) {
                    quizContainer.mozRequestFullScreen();
                } else if (quizContainer.webkitRequestFullscreen) {
                    quizContainer.webkitRequestFullscreen();
                } else if (quizContainer.msRequestFullscreen) {
                    quizContainer.msRequestFullscreen();
                }

                // Start timers
                examStartTime = Date.now();
                overallTimerInterval = setInterval(updateOverallTimer, 1000);

                // Hide modal
                document.getElementById("startExamModal").style.display = "none";

                // Start inactivity timer
                resetInactivityTimer();
            });

            // Update the overall timer
            function updateOverallTimer() {
                const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
                document.getElementById("totalTime").textContent = formatTime(elapsed);
            }

            // Format time in MM:SS format
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return (mins < 10 ? "0" + mins : mins) + ":" + (secs < 10 ? "0" + secs : secs);
            }
            // Reset inactivity timer
            function resetInactivityTimer() {
                clearTimeout(inactivityTimeout);
                inactivityTimeout = setTimeout(() => {
                    alert("@Html.Raw(@_localization.GetKey("ExamCanceledInactivity"))");
                    autoSubmitQuizAndRedirect('@inactivityUrl');
                }, 120000);
            }

            // Prevent user from leaving fullscreen
            document.addEventListener("fullscreenchange", function () {
                if (!document.fullscreenElement) {
                    alert("@Html.Raw(@_localization.GetKey("ExamCanceledFullscreenExit"))");
                    autoSubmitQuizAndRedirect('@fullscreenExitUrl');
                }
            });

            document.addEventListener("mouseleave", () => {
                warningTimeout = setTimeout(() => {
                    alert("@Html.Raw(@_localization.GetKey("ExamCanceledLeaveScreen"))");
                    autoSubmitQuizAndRedirect('@leaveScreenUrl');
                }, 3000);
            });

            // Clear warning timeout if mouse re-enters the screen
            document.addEventListener("mouseenter", () => clearTimeout(warningTimeout));

            // Show the current question based on index
            function showQuestion(index) {
                const panels = document.querySelectorAll('.question-panel');
                panels.forEach((panel, i) => {
                    panel.style.display = (i === index) ? "block" : "none";
                });
                questionStartTime = Date.now();
            }

            // Handle Next and Previous button clicks
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('nextBtn')) {
                    let currentTime = Math.floor((Date.now() - questionStartTime) / 1000);
                    let currentPanel = document.querySelector('.question-panel[data-index="' + currentQuestionIndex + '"]');
                    let timeInput = currentPanel.querySelector('.question-time');
                    timeInput.value = currentTime;

                    currentQuestionIndex++;
                    showQuestion(currentQuestionIndex);
                } else if (e.target.classList.contains('prevBtn')) {
                    currentQuestionIndex--;
                    showQuestion(currentQuestionIndex);
                }

                // Reset inactivity timer on any user interaction
                resetInactivityTimer();
            });

            // Handle form submission
            document.getElementById('quizForm').addEventListener('submit', function (event) {
                if (isSubmitting) {
                    event.preventDefault(); // Çift gönderimi tamamen engelle
                    return;
                }
                
                // Check if all questions are answered
                const panels = document.querySelectorAll('.question-panel');
                let allAnswered = true;
                panels.forEach(panel => {
                    const radios = panel.querySelectorAll('input[type="radio"]');
                    const answered = Array.from(radios).some(radio => radio.checked);
                    if (!answered) {
                        allAnswered = false;
                    }
                });
                
                if (!allAnswered) {
                    event.preventDefault();
                    alert("@Html.Raw(@_localization.GetKey("PleaseAnswerAllQuestions") ?? "Lütfen tüm soruları cevaplayın!")");
                    return;
                }
                
                isSubmitting = true;
                showLoadingOverlay();
                
                const totalElapsed = Math.floor((Date.now() - examStartTime) / 1000);
                document.getElementById('elapsedTime').value = totalElapsed;
                clearInterval(overallTimerInterval);
                clearTimeout(inactivityTimeout);
            });
        });
    </script>
}