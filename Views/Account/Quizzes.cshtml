@using Microsoft.AspNetCore.Identity
@inject SignInManager<SpeakingClub.Identity.User> SignInManager
@model CombinedQuizzesViewModel
@{
    ViewData["Title"] = "Quizler";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Css{
<style>
    :root {
        --quiz-lightest: #FFF5E4;
        --quiz-light: #FFE3E1;
        --quiz-medium: #FFD1D1;
        --quiz-accent: #FF9494;
    }
    
    .main-bg { 
        background: linear-gradient(180deg, var(--quiz-light) 0%, var(--quiz-lightest) 100%) !important;
        min-height: 100vh;
    }
    
    /* Header Section */
    .quiz-hero {
        background: linear-gradient(135deg, var(--quiz-medium) 0%, var(--quiz-light) 100%);
        padding: 3rem 0 2rem;
        margin-bottom: 2rem;
        border-radius: 0 0 30px 30px;
    }
    .quiz-hero h1 {
        color: var(--quiz-accent);
        font-weight: 800;
    }
    
    /* Sidebar Styling */
    aside { 
        background: white; 
        border-radius: 20px; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    }
    .aside-inner { 
        padding: 2rem; 
    }
    .aside-inner .form-control,
    .aside-inner .form-select {
        border-radius: 12px;
        border: 2px solid var(--quiz-light);
        padding: 12px 15px;
    }
    .aside-inner .form-control:focus,
    .aside-inner .form-select:focus {
        border-color: var(--quiz-accent);
        box-shadow: 0 0 0 3px rgba(255,148,148,0.2);
    }
    .search-btn { 
        background: linear-gradient(135deg, var(--quiz-accent) 0%, var(--quiz-medium) 100%);
        color: #fff; 
        font-weight: 600; 
        border-radius: 12px;
        border: none;
        padding: 12px 20px;
    }
    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255,148,148,0.4);
        color: white;
    }
    .section-label {
        color: var(--quiz-accent);
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tag-filter {
        cursor: pointer; 
        background: var(--quiz-light); 
        color: #666; 
        margin: 3px;
        border-radius: 20px; 
        font-weight: 600; 
        font-size: 0.9em; 
        padding: 8px 16px; 
        display: inline-block;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .tag-filter:hover {
        background: var(--quiz-medium);
        color: #444;
    }
    .tag-filter.active { 
        background: var(--quiz-accent) !important; 
        color: #fff;
        border-color: var(--quiz-accent);
    }
    
    /* Quiz Cards */
    .card.quiz-card {
        background: white; 
        border: none; 
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        min-height: 480px; 
        display: flex; 
        flex-direction: column;
        overflow: hidden;
    }
    .card.quiz-card:hover { 
        box-shadow: 0 15px 40px rgba(255,148,148,0.25); 
        transform: translateY(-8px);
    }
    .quiz-card .card-body { 
        flex: 1 1 auto; 
        display: flex; 
        flex-direction: column;
        padding: 1.5rem;
    }
    .quiz-badges .badge {
        background: var(--quiz-light); 
        color: var(--quiz-accent); 
        font-weight: 600;
        border-radius: 20px; 
        margin-right: 5px; 
        font-size: 0.85em;
        padding: 5px 12px;
    }
    .quiz-category { 
        color: var(--quiz-accent); 
        font-size: 0.9em; 
        font-weight: 700; 
        margin-bottom: .5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .quiz-meta { 
        font-size: .9em; 
        color: #888; 
        margin-bottom: .5rem;
    }
    .quiz-meta i {
        color: var(--quiz-accent);
    }
    .quiz-result { 
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        padding: 10px 15px;
        border-radius: 12px;
        color: #2e7d32; 
        font-size: 0.9em; 
        font-weight: 600;
    }
    .quiz-media { 
        background: var(--quiz-lightest); 
        border-radius: 20px 20px 0 0; 
    }
    .swiper { 
        width: 100%; 
        height: 200px; 
    }
    .swiper-slide { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        background: var(--quiz-lightest);
    }
    .swiper-slide img, 
    .swiper-slide iframe, 
    .swiper-slide audio { 
        max-width: 100%; 
        max-height: 200px; 
        object-fit: cover; 
        border-radius: 20px 20px 0 0;
    }
    .swiper-slide audio { 
        width: 90%; 
        margin: auto;
    }
    .swiper-button-next, .swiper-button-prev {
        color: var(--quiz-accent);
        background: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .swiper-button-next::after, .swiper-button-prev::after {
        font-size: 14px;
        font-weight: bold;
    }
    .swiper-pagination-bullet-active {
        background: var(--quiz-accent);
    }
    
    /* Buttons */
    .btn-quiz-start {
        background: linear-gradient(135deg, var(--quiz-accent) 0%, var(--quiz-medium) 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }
    .btn-quiz-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255,148,148,0.4);
        color: white;
    }
    .btn-quiz-login {
        background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
        color: #333;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        padding: 12px 20px;
    }
    .btn-quiz-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255,193,7,0.4);
        color: #333;
    }
    .btn-quiz-review {
        background: transparent;
        border: 2px solid var(--quiz-accent);
        color: var(--quiz-accent);
        border-radius: 12px;
        font-weight: 600;
    }
    .btn-quiz-review:hover {
        background: var(--quiz-accent);
        color: white;
    }
    
    /* Pagination */
    .pagination .page-link {
        border: none;
        border-radius: 10px;
        margin: 0 3px;
        color: var(--quiz-accent);
        font-weight: 600;
        padding: 10px 15px;
    }
    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, var(--quiz-accent) 0%, var(--quiz-medium) 100%);
        border: none;
    }
    .pagination .page-link:hover {
        background-color: var(--quiz-light);
    }
    
    /* Login Alert */
    .login-alert {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: none;
        border-radius: 15px;
        padding: 1.25rem 1.5rem;
    }
    .login-alert a {
        color: var(--quiz-accent);
        font-weight: 600;
    }
    
    /* Modal */
    .modal-content {
        border-radius: 20px;
        border: none;
    }
    .modal-header {
        background: linear-gradient(135deg, var(--quiz-light) 0%, var(--quiz-lightest) 100%);
        border-radius: 20px 20px 0 0;
        border: none;
    }
    .modal-title {
        color: var(--quiz-accent);
        font-weight: 700;
    }
    
    @@media (max-width:991px) {
        .swiper, .swiper-slide img, .swiper-slide iframe { height: 160px;}
        aside { margin-bottom: 1.5rem;}
    }
    @@media (max-width:767px) {
        .swiper, .swiper-slide img, .swiper-slide iframe { height: 120px;}
        .aside-inner { padding: 1.25rem;}
        .card.quiz-card { min-height: 420px;}
        .quiz-hero { padding: 2rem 0 1.5rem; }
    }
</style>
}

<div class="main-bg pb-5">
    <!-- Hero Section -->
    <div class="quiz-hero text-center">
        <div class="container">
            <h1 class="display-5 mb-2"><i class="bi bi-patch-question me-2"></i>Quizler</h1>
            <p class="text-muted mb-0">Almanca seviyenizi test edin ve kendinizi geliştirin!</p>
        </div>
    </div>
    
    <div class="container">
        <div class="row gy-4">
            <!-- Sol Panel -->
            <aside class="col-lg-3 col-md-4">
                <div class="aside-inner">
                    <form id="quizSearchForm" class="mb-4 text-black" onsubmit="event.preventDefault();doFilter(1);">
                        <div class="input-group">
                            <input id="quizSearch" type="text" class="form-control" placeholder="Quiz ara...">
                            <button class="btn search-btn" type="submit"><i style="color: black;" class="fas fa-search"></i></button>
                        </div>
                    </form>
                    <button type="button" id="clearFiltersBtn" class="btn btn-outline-secondary w-100 mb-4" style="border-radius: 12px; font-weight: 600;">
                        <i class="bi bi-arrow-counterclockwise me-2"></i> Filtreleri Temizle
                    </button>
                    <div class="mb-4">
                        <div class="section-label"><i class="bi bi-tags"></i> Etiketler</div>
                        <div id="tagFilters">
                            <span class="tag-filter active" data-tag="">Tümü</span>
                            @{
                                var allTags = (Model.AvailableQuizzes ?? Enumerable.Empty<QuizSummaryViewModel>())
                                    .SelectMany(q => q.Tags ?? new List<SpeakingClub.Entity.Tag>())
                                    .Select(t => t.Name)
                                    .Distinct()
                                    .OrderBy(x => x);
                                foreach (var tag in allTags)
                                {
                                    <span class="tag-filter" data-tag="@tag">@tag</span>
                                }
                            }
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="section-label"><i class="bi bi-folder"></i> Kategori</div>
                        <select id="categoryFilter" class="form-select">
                            <option value="">Tüm Kategoriler</option>
                            @{
                                var allCats = (Model.AvailableQuizzes ?? Enumerable.Empty<QuizSummaryViewModel>()).Select(q => q.CategoryName).Distinct();
                                foreach (var cat in allCats)
                                {
                                    if (!string.IsNullOrWhiteSpace(cat))
                                    {
                                        <option value="@cat">@cat</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
            </aside>

            <!-- Quiz Kartları -->
            <main class="col-lg-9 col-md-8">
                @if (!SignInManager.IsSignedIn(User))
                {
                    <div class="login-alert mb-4" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-3 fs-4" style="color: var(--quiz-accent);"></i>
                            <div>
                                <strong>Quiz çözmek için giriş yapmanız gerekmektedir.</strong><br>
                                <span class="text-muted">Sonuçlarınızı kaydetmek ve ilerlemenizi takip etmek için 
                                <a asp-action="Login" asp-controller="Account">giriş yapın</a> veya 
                                <a asp-action="Register" asp-controller="Account">kayıt olun</a>.</span>
                            </div>
                        </div>
                    </div>
                }
                <div class="row g-4" id="quizList">
                    @foreach (var quiz in Model.AvailableQuizzes ?? Enumerable.Empty<QuizSummaryViewModel>())
                    {
                        var tagNames = string.Join(",", quiz.Tags?.Select(t => t.Name) ?? Enumerable.Empty<string>());
                        <div class="col-md-6 col-lg-4 d-flex quiz-item" data-tags="@tagNames" data-category="@quiz.CategoryName">
                            <div class="card quiz-card w-100">
                                <!-- Quiz Medya Swiper: Resim, Video, Ses-->
                                <div class="quiz-media swiper mySwiper">
                                    <div class="swiper-wrapper">
                                        @if (!string.IsNullOrEmpty(quiz.ImageUrl))
                                        {
                                            <div class="swiper-slide">
                                                <img src="@quiz.ImageUrl" class="img-fluid" alt="@quiz.QuizTitle" loading="lazy"/>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(quiz.YouTubeVideoUrl))
                                        {
                                            <div class="swiper-slide">
                                                <div class="ratio ratio-16x9 w-100">
                                                    <iframe src="@quiz.YouTubeVideoUrl"
                                                            title="Quiz Video" allowfullscreen></iframe>
                                                </div>
                                            </div>
                                        }
                                        @* Ses dosyası varsa: *@
                                        @if (!string.IsNullOrEmpty(quiz.AudioUrl))
                                        {
                                            <div class="swiper-slide d-flex align-items-center justify-content-center">
                                                <audio controls>
                                                    <source src="@quiz.AudioUrl" type="audio/mpeg" />
                                                    Tarayıcınız audio etiketini desteklemiyor.
                                                </audio>
                                            </div>
                                        }
                                    </div>
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination"></div>
                                </div>
                                <!-- Swiper sonu -->

                                <div class="card-body">
                                    <div class="quiz-category"><i class="bi bi-folder2 me-1"></i>@quiz.CategoryName</div>
                                    <div class="quiz-badges mb-2">
                                        @foreach (var tag in quiz.Tags ?? new List<SpeakingClub.Entity.Tag>())
                                        {
                                            <span class="badge">@tag.Name</span>
                                        }
                                    </div>
                                    <h5 class="card-title fw-bold mb-2">@quiz.QuizTitle</h5>
                                    <div class="quiz-meta mb-2"><i class="bi bi-person-circle me-1"></i> @quiz.TeacherName</div>
                                    <div class="mb-3" style="font-size:.95em; color:#555; line-height: 1.5;">
                                        @(quiz.QuizDescription != null && quiz.QuizDescription.Length > 100
                                            ? quiz.QuizDescription.Substring(0, 100) + "..."
                                            : quiz.QuizDescription)
                                    </div>
                                    @if (quiz.LastAttemptDate.HasValue && SignInManager.IsSignedIn(User))
                                    {
                                        <div class="quiz-result mb-3">
                                            <i class="bi bi-check-circle-fill me-1"></i>
                                            Son Çözüm: @quiz.LastAttemptDate.Value.ToShortDateString()
                                            <span class="ms-2"><i class="bi bi-trophy-fill me-1"></i>Skor: @(quiz.LastScore?.ToString() ?? "0")</span>
                                        </div>
                                    }
                                    <div class="mt-auto">
                                        @if (SignInManager.IsSignedIn(User))
                                        {
                                            <button type="button"
                                                    class="btn btn-quiz-start w-100 mb-2 start-quiz-btn"
                                                    data-quiz-id="@quiz.QuizId"
                                                    data-quiz-title="@quiz.QuizTitle">
                                                <i class="bi bi-play-fill me-1"></i> Quiz'e Başla
                                            </button>
                                        }
                                        else
                                        {
                                            <a asp-action="Login" asp-controller="Account" asp-route-returnUrl="@Url.Action("Quizzes", "Account")" class="btn btn-quiz-login w-100 mb-2">
                                                <i class="bi bi-lock-fill me-1"></i> Quiz için Giriş Yapın
                                            </a>
                                        }
                                        @if (quiz.LastAttemptDate.HasValue && SignInManager.IsSignedIn(User))
                                        {
                                            <a asp-action="ReviewQuiz"
                                            asp-controller="Account"
                                            asp-route-id="@quiz.QuizId"
                                            class="btn btn-quiz-review w-100">
                                                <i class="bi bi-eye me-1"></i> Gözden Geçir
                                            </a>
                                        }
                                    </div>

                                </div>
                            </div>
                        </div>
                    }
                </div>
                <!-- Pagination -->
                <nav class="mt-5">
                    <ul class="pagination justify-content-center" id="quizPagination"></ul>
                </nav>
            </main>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="startQuizModal" tabindex="-1" aria-labelledby="startQuizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="startQuizModalLabel">Quiz’e Başla</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div class="fw-bold mb-2" id="modalQuizTitle"></div>
        <p>Bu sınava başlamak istediğine emin misin?<br>
          <small>Sınav başladıktan sonra, sınavı tam ekran modunda bitirmen gerekmektedir.</small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
        <!-- ASP.NET tag helper ile yönlendirme -->
        <form id="startQuizForm" asp-action="StartQuiz" asp-controller="Account" method="get">
            <input type="hidden" id="modalQuizId" name="id" value="" />
            <button type="submit" class="btn btn-primary">Şimdi Başla</button>
        </form>
      </div>
    </div>
  </div>
</div>


@section Scripts {
<script>
window.doFilter = function(page){
    page = page || 1;
    var search = $('#quizSearch').val().toLowerCase().trim();
    var tag = $('#tagFilters .tag-filter.active').data('tag') || '';
    var cat = $('#categoryFilter').val() || '';
    
    var cards = $('.quiz-item');
    var matched = [];
    
    cards.each(function(){
        var $c = $(this);
        var title = $c.find('.card-title').text().toLowerCase();
        var cardTags = ($c.data('tags') || '').toString().toLowerCase();
        var category = ($c.data('category') || '').toString().trim();
        
        var matchSearch = !search || title.indexOf(search) >= 0;
        var matchTag = !tag || tag === '' || cardTags.indexOf(tag.toLowerCase()) >= 0;
        var matchCat = !cat || cat === '' || category === cat.trim();
        
        if(matchSearch && matchTag && matchCat) {
            matched.push(this);
        }
    });
    
    // Pagination
    var size = 6, total = matched.length;
    var pages = Math.ceil(total/size) || 1;
    if(page > pages) page = 1;
    var start = (page-1)*size;
    
    // Hide all, show matched for current page
    cards.hide();
    for(var j = 0; j < matched.length; j++){
        if(j >= start && j < start + size){
            $(matched[j]).show();
        }
    }
    
    // Pagination links
    var h = '';
    if(pages > 1){
        for(var i=1; i<=pages; i++){
            h += '<li class="page-item '+(i==page?'active':'')+'"><a class="page-link" href="#" data-p="'+i+'">'+i+'</a></li>';
        }
    }
    $('#quizPagination').html(h);
};
};

$(function(){
    console.log('Script ready, quiz items:', $('.quiz-item').length);
    
    // Events
    $('#quizSearch').on('input keyup', function(){ 
        console.log('Search changed to:', $(this).val());
        doFilter(1); 
    });
    $('#quizSearchForm').on('submit', function(e){ e.preventDefault(); doFilter(1); });
    $('#categoryFilter').on('change', function(){ 
        console.log('Category changed to:', $(this).val());
        doFilter(1); 
    });
    
    $('#tagFilters').on('click', '.tag-filter', function(){
        console.log('Tag clicked:', $(this).data('tag'));
        $('#tagFilters .tag-filter').removeClass('active');
        $(this).addClass('active');
        doFilter(1);
    });
    
    $('#clearFiltersBtn').on('click', function(){
        console.log('Clear clicked');
        $('#quizSearch').val('');
        $('#categoryFilter').val('');
        $('#tagFilters .tag-filter').removeClass('active');
        $('#tagFilters .tag-filter[data-tag=""]').addClass('active');
        doFilter(1);
    });
    
    $('#quizPagination').on('click', 'a', function(e){
        e.preventDefault();
        doFilter($(this).data('p'));
    });
    
    // Quiz modal
    $(document).on('click', '.start-quiz-btn', function(){
        $('#modalQuizId').val($(this).data('quiz-id'));
        $('#modalQuizTitle').text($(this).data('quiz-title'));
        new bootstrap.Modal($('#startQuizModal')[0]).show();
    });
    
    // Init Swiper
    $('.mySwiper').each(function(){
        new Swiper(this, {
            loop: false,
            navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
            pagination: { el: '.swiper-pagination', clickable: true }
        });
    });
    
    // Initial load
    console.log('Running initial doFilter');
    doFilter(1);
});
</script>
}
